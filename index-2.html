<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare CRM - Interactive Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet preconnect" >
    <style>
        :root {
            --spinner-size: 1em;
            --spinner-border-width: 2px;
            --spinner-border-color: #fff;
            --spinner-border-partial-color: rgba(255, 255, 255, 0.3);
        }
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .spinner {
            border: var(--spinner-border-width) solid var(--spinner-border-partial-color);
            border-radius: 50%;
            border-top-color: var(--spinner-border-color);
            width: var(--spinner-size);
            height: var(--spinner-size);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    </head>
<body class="bg-gray-100 dark:bg-gray-900">
    <noscript>
        <div style="padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; text-align: center;">
            This application requires JavaScript to function properly. Please enable JavaScript in your browser settings.
        </div>
    </noscript>

    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 via-purple-100 to-indigo-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800">Healthcare CRM Login</h2>
            <p class="text-center text-gray-600">Access your account</p>
            <form id="login-form" class="space-y-6">
                <div><label for="username" class="text-sm font-medium text-gray-700 block mb-2">Username</label><input id="username" type="text" required placeholder="e.g., admin, doctor, staff" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out" autocomplete="username" data-testid="username-input"/></div>
                <div><label for="password" class="text-sm font-medium text-gray-700 block mb-2">Password</label><input id="password" type="password" required placeholder="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out" autocomplete="current-password" minlength="8" data-testid="password-input"/></div>
                <p id="login-error" class="text-sm text-red-600 text-center hidden">Invalid username or password.</p>
                <div>
                    <button type="submit" id="login-button" data-testid="login-button" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-75" aria-live="polite" aria-busy="false">
                        <span class="default-text">Login</span>
                        <span class="loading-state hidden items-center gap-2" aria-hidden="true">
                            <span class="spinner"></span>
                            <span>Logging in...</span>
                        </span>
                    </button>
                </div>
                <p class="text-xs text-center text-gray-500">Use 'admin'/'password', 'doctor'/'password', or 'staff'/'password'</p>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden flex h-screen bg-gray-100 dark:bg-gray-900">
        <div class="w-64 bg-gradient-to-b from-gray-800 to-gray-900 text-white flex flex-col flex-shrink-0 h-screen">
            <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-gray-700 flex-shrink-0 sticky top-0 bg-gradient-to-b from-gray-800 to-gray-900 z-10">Health CRM</div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                <button type="button" data-page="dashboard" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/layout-dashboard.svg" alt="Dashboard" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Dashboard</span></button>
                <button type="button" data-page="patients" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/users.svg" alt="Patients" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Patients</span></button>
                <button type="button" data-page="appointments" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/calendar.svg" alt="Appointments" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Appointments</span></button>
                 <button type="button" data-page="billing" data-roles="Administrator,Staff" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/dollar-sign.svg" alt="Billing" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Billing</span></button>
                 <button type="button" data-page="messages" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/message-square.svg" alt="Messages" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Messages</span></button>
                 <button type="button" data-page="reports" data-roles="Administrator,Doctor" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/file-text.svg" alt="Reports" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Reports</span></button>
                 <button type="button" data-page="settings" class="nav-button w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition duration-150 ease-in-out group text-gray-300 hover:bg-gray-700 hover:text-white"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/settings.svg" alt="Settings" class="nav-icon mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-100"/><span>Settings</span></button>
            </nav>
            <div class="px-4 py-4 border-t border-gray-700 flex-shrink-0 sticky bottom-0 bg-gradient-to-t from-gray-800 to-gray-900 z-10"><button type="button" id="logout-button" class="w-full flex items-center px-3 py-2.5 rounded-lg text-sm font-medium text-red-400 hover:bg-red-800 hover:text-white transition duration-150 ease-in-out group"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/log-out.svg" alt="Logout" class="mr-3 flex-shrink-0 h-5 w-5 filter brightness-50 group-hover:brightness-0 group-hover:invert"/>Logout</button></div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white dark:bg-gray-800 dark:border-gray-700 shadow-md flex items-center justify-between px-6 flex-shrink-0 border-b">
                <div><span class="text-sm text-gray-500 dark:text-gray-400 font-medium">Indore Clinic Portal</span></div>
                <div class="flex items-center gap-4">
                     <button type="button" id="dark-mode-toggle" data-testid="dark-mode-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800" aria-label="Toggle dark mode">
                        <img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/sun.svg" alt="Light mode" class="w-5 h-5 block dark:hidden"/>
                        <img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/moon.svg" alt="Dark mode" class="w-5 h-5 hidden dark:block"/>
                    </button>
                    <button type="button" id="notification-button" data-testid="notification-button" class="relative text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800" title="Notifications" aria-label="View notifications">
                        <img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/bell.svg" alt="" class="w-5 h-5 pointer-events-none"/>
                        <span id="notification-badge" data-testid="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full px-1.5 py-0.5 min-w-[18px] h-[18px] flex items-center justify-center border-2 border-white dark:border-gray-800 hidden" aria-live="polite">0</span>
                    </button>
                    <div class="flex items-center cursor-pointer group">
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold mr-2 border border-gray-300 dark:border-gray-600">?</div>
                        <div class="text-sm">
                            <span id="user-name" class="font-medium text-gray-800 dark:text-gray-200 block leading-tight">User Name</span>
                            <span id="user-role" class="text-xs text-gray-500 dark:text-gray-400 block leading-tight">User Role</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6">
                <div id="page-dashboard" class="page-content space-y-6">
                    <h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Dashboard</h1><p class="text-gray-600 dark:text-gray-400">Welcome back! Here's a summary of your activities.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Patients</p><p class="text-2xl font-semibold text-gray-800 dark:text-gray-100">3</p></div><div class="p-3 bg-blue-100 dark:bg-blue-900/50 rounded-full"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/users.svg" alt="Users" class="w-6 h-6 text-blue-500 dark:text-blue-400"/></div></div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Appointments Today</p><p class="text-2xl font-semibold text-gray-800 dark:text-gray-100">0</p></div><div class="p-3 bg-green-100 dark:bg-green-900/50 rounded-full"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/clock.svg" alt="Clock" class="w-6 h-6 text-green-500 dark:text-green-400"/></div></div>
                        <button type="button" data-page="appointments" class="page-link bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md cursor-pointer transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"><div><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Upcoming Appointments</p><p class="text-2xl font-semibold text-gray-800 dark:text-gray-100">3</p></div><div class="p-3 bg-purple-100 dark:bg-purple-900/50 rounded-full"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/calendar.svg" alt="Calendar" class="w-6 h-6 text-purple-500 dark:text-purple-400"/></div></button>
                        <button type="button" data-page="billing" data-roles="Administrator,Staff" class="page-link bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md cursor-pointer transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"><div><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pending Bills</p><p class="text-2xl font-semibold text-gray-800 dark:text-gray-100">2</p></div><div class="p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-full"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/dollar-sign.svg" alt="Dollar" class="w-6 h-6 text-yellow-500 dark:text-yellow-400"/></div></button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Upcoming Appointments</h2><ul class="space-y-3"><li class="text-sm text-gray-600 dark:text-gray-300 border-b dark:border-gray-700 pb-2 last:border-b-0"><p><span class="font-medium dark:text-gray-100">Ananya Singh</span> with Dr. Priya Singh</p><p>4/5/2025 at 11:00 AM</p><p>Reason: Initial Consultation</p></li><li class="text-sm text-gray-600 dark:text-gray-300 border-b dark:border-gray-700 pb-2 last:border-b-0"><p><span class="font-medium dark:text-gray-100">Priya Sharma</span> with Dr. Rohan Gupta</p><p>4/10/2025 at 10:00 AM</p><p>Reason: Annual Checkup</p></li><li class="text-sm text-gray-600 dark:text-gray-300 border-b dark:border-gray-700 pb-2 last:border-b-0"><p><span class="font-medium dark:text-gray-100">Rohan Verma</span> with Dr. Priya Singh</p><p>4/11/2025 at 02:30 PM</p><p>Reason: Follow-up</p></li></ul><button type="button" data-page="appointments" class="page-link mt-4 text-sm text-blue-600 dark:text-blue-400 hover:underline">View All Appointments</button></div>
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow" data-roles="Administrator,Doctor"><h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Key Metrics</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-64"><div><h3 class="text-center text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Appointment Adherence</h3><div class="chart-placeholder h-full w-full">Chart Area 1</div></div><div><h3 class="text-center text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">New Patient Acquisition</h3><div class="chart-placeholder h-full w-full">Chart Area 2</div></div></div><button type="button" data-page="reports" class="page-link mt-4 text-sm text-blue-600 dark:text-blue-400 hover:underline">View Full Reports</button></div>
                    </div>
                </div>

                <div id="page-patients" class="page-content hidden space-y-6">
                    <div class="flex justify-between items-center"><h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Patient Records</h1><button type="button" id="add-patient-button" data-testid="add-patient-button" data-roles="Administrator,Staff" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/plus-circle.svg" alt="Add" class="w-5 h-5 mr-2 invert brightness-0"/> Add New Patient</button></div>
                    <div class="relative"><input type="text" placeholder="Search patients by name or ID..." class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"/><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/search.svg" alt="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-gray-500"/></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow overflow-x-auto">
                        <table class="w-full min-w-max text-left text-sm">
                            <thead><tr class="border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50"><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Patient ID</th><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Name</th><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Date of Birth</th><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Gender</th><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Contact</th><th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Actions</th></tr></thead>
                            <tbody id="patient-table-body">
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-patient-id="p001" data-patient-name="Priya Sharma">
                                    <td class="p-3 text-gray-700 dark:text-gray-300">p001</td><td class="p-3 text-gray-900 dark:text-gray-100 font-medium">Priya Sharma</td><td class="p-3 text-gray-700 dark:text-gray-300">1990-05-15</td><td class="p-3 text-gray-700 dark:text-gray-300">Female</td><td class="p-3 text-gray-700 dark:text-gray-300">555-1234</td>
                                    <td class="p-3 text-gray-700 dark:text-gray-300"><div class="flex items-center gap-2">
                                        <button type="button" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1 rounded hover:bg-blue-100 dark:hover:bg-gray-700" title="View Details" aria-label="View patient details"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/user.svg" alt="View" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator,Staff" class="edit-patient-button text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 p-1 rounded hover:bg-yellow-100 dark:hover:bg-gray-700" title="Edit Patient" aria-label="Edit patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/edit.svg" alt="Edit" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator" class="delete-patient-button text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1 rounded hover:bg-red-100 dark:hover:bg-gray-700" title="Delete Patient" aria-label="Delete patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/trash-2.svg" alt="Delete" class="w-4 h-4 pointer-events-none"/></button>
                                    </div></td>
                                </tr>
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-patient-id="p002" data-patient-name="Rohan Verma">
                                    <td class="p-3 text-gray-700 dark:text-gray-300">p002</td><td class="p-3 text-gray-900 dark:text-gray-100 font-medium">Rohan Verma</td><td class="p-3 text-gray-700 dark:text-gray-300">1985-11-20</td><td class="p-3 text-gray-700 dark:text-gray-300">Male</td><td class="p-3 text-gray-700 dark:text-gray-300">555-5678</td>
                                    <td class="p-3 text-gray-700 dark:text-gray-300"><div class="flex items-center gap-2">
                                        <button type="button" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1 rounded hover:bg-blue-100 dark:hover:bg-gray-700" title="View Details" aria-label="View patient details"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/user.svg" alt="View" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator,Staff" class="edit-patient-button text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 p-1 rounded hover:bg-yellow-100 dark:hover:bg-gray-700" title="Edit Patient" aria-label="Edit patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/edit.svg" alt="Edit" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator" class="delete-patient-button text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1 rounded hover:bg-red-100 dark:hover:bg-gray-700" title="Delete Patient" aria-label="Delete patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/trash-2.svg" alt="Delete" class="w-4 h-4 pointer-events-none"/></button>
                                    </div></td>
                                </tr>
                                 <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-patient-id="p003" data-patient-name="Ananya Singh">
                                    <td class="p-3 text-gray-700 dark:text-gray-300">p003</td><td class="p-3 text-gray-900 dark:text-gray-100 font-medium">Ananya Singh</td><td class="p-3 text-gray-700 dark:text-gray-300">1978-04-16</td><td class="p-3 text-gray-700 dark:text-gray-300">Female</td><td class="p-3 text-gray-700 dark:text-gray-300">555-9012</td>
                                    <td class="p-3 text-gray-700 dark:text-gray-300"><div class="flex items-center gap-2">
                                        <button type="button" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1 rounded hover:bg-blue-100 dark:hover:bg-gray-700" title="View Details" aria-label="View patient details"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/user.svg" alt="View" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator,Staff" class="edit-patient-button text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 p-1 rounded hover:bg-yellow-100 dark:hover:bg-gray-700" title="Edit Patient" aria-label="Edit patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/edit.svg" alt="Edit" class="w-4 h-4 pointer-events-none"/></button>
                                        <button type="button" data-roles="Administrator" class="delete-patient-button text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1 rounded hover:bg-red-100 dark:hover:bg-gray-700" title="Delete Patient" aria-label="Delete patient"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/trash-2.svg" alt="Delete" class="w-4 h-4 pointer-events-none"/></button>
                                    </div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="page-appointments" class="page-content hidden space-y-6"><h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Appointments</h1><p class="text-gray-500 dark:text-gray-400">Appointments list and scheduling controls would go here.</p></div>
                <div id="page-billing" class="page-content hidden space-y-6" data-roles="Administrator,Staff"><h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Billing & Invoices</h1><p class="text-gray-500 dark:text-gray-400">Billing records table and invoice creation controls would go here.</p></div>
                <div id="page-messages" class="page-content hidden space-y-6"><h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Internal Messages</h1><p class="text-gray-500 dark:text-gray-400">Messaging interface (list and view) would go here.</p></div>
                <div id="page-reports" class="page-content hidden space-y-6" data-roles="Administrator,Doctor"><h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Reports & Analytics</h1><p class="text-gray-500 dark:text-gray-400">Report charts and filters would go here.</p></div>

                <div id="page-settings" class="page-content hidden space-y-6">
                    <h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Settings</h1>
                    <p class="text-gray-500 dark:text-gray-400">Manage your preferences.</p>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">User Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                                <input type="text" id="profile-name" name="name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                            </div>
                            <div>
                                <label for="profile-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                                <input type="password" id="profile-password" name="password" minlength="8" placeholder="Optional - Enter to change" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow">Save Profile</button>
                        </form>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Notifications</h2>
                        <label class="flex items-center">
                            <input type="checkbox" id="notify-app" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" checked />
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">In-app notifications</span>
                        </label>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow" data-roles="Administrator">
                        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">User Management</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr class="border-b dark:border-gray-700">
                                        <th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Username</th>
                                        <th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Name</th>
                                        <th class="p-3 font-semibold text-gray-600 dark:text-gray-300">Role</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body" class="dark:text-gray-300">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="access-denied" class="page-content hidden text-center p-10 bg-white dark:bg-gray-800 rounded-lg shadow"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/ban.svg" alt="Access Denied" class="w-12 h-12 text-red-400 mx-auto mb-4"/><h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Access Denied</h2><p class="text-red-600 dark:text-red-400">You do not have permission to view this page.</p></div>
            </main>
        </div>
    </div>

    <div id="add-patient-modal" role="dialog" aria-modal="true" aria-labelledby="add-patient-modal-title" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700 rounded-t-lg flex-shrink-0"><h3 id="add-patient-modal-title" class="text-xl font-semibold text-gray-800 dark:text-gray-100">Add New Patient</h3><button type="button" class="modal-close-button text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Close modal"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x-circle.svg" alt="Close" class="w-6 h-6 pointer-events-none"/></button></div>
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="add-patient-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="m-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label><input type="text" id="m-name" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                        <div><label for="m-dob" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth <span class="text-red-500">*</span></label><input type="date" id="m-dob" name="dob" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                        <div><label for="m-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender <span class="text-red-500">*</span></label><select id="m-gender" name="gender" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm bg-white dark:bg-gray-700 appearance-none"><option value="" disabled selected>Select Gender...</option><option value="Female">Female</option><option value="Male">Male</option><option value="Other">Other</option></select></div>
                        <div><label for="m-contact" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Number <span class="text-red-500">*</span></label><input type="tel" id="m-contact" name="contact" required placeholder="e.g., 555-123-4567" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" title="Format: 555-123-4567" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                    </div>
                    <div><label for="m-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address</label><textarea id="m-address" name="address" rows="3" placeholder="Enter full address..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"></textarea></div>
                    <div><label for="m-medicalHistory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Medical History</label><textarea id="m-medicalHistory" name="medicalHistory" rows="3" placeholder="List conditions, allergies..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"></textarea></div>
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-200 pt-4 border-t dark:border-gray-700 mt-4 mb-2">Insurance (Optional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="m-insuranceProvider" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Provider</label><input type="text" id="m-insuranceProvider" name="insuranceProvider" placeholder="e.g., HealthCo" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                        <div><label for="m-insurancePolicyId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Policy ID</label><input type="text" id="m-insurancePolicyId" name="insurancePolicyId" placeholder="e.g., HC12345" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                    </div>
                    <div class="flex justify-end gap-3 pt-5 border-t dark:border-gray-700 mt-6">
                        <button type="button" class="modal-close-button font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 focus:ring-gray-400 dark:focus:ring-gray-500 border border-gray-300 dark:border-gray-500 py-2 px-4 text-sm">Cancel</button>
                        <button type="submit" class="font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500 py-2 px-4 text-sm">Add Patient</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-patient-modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700 rounded-t-lg flex-shrink-0"><h3 id="edit-modal-title" class="text-xl font-semibold text-gray-800 dark:text-gray-100">Edit Patient</h3><button type="button" class="modal-close-button text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Close modal"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x-circle.svg" alt="Close" class="w-6 h-6 pointer-events-none"/></button></div>
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="edit-patient-form" class="space-y-4">
                    <input type="hidden" id="edit-patient-id" name="patientId"/>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="edit-m-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label><input type="text" id="edit-m-name" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                        <div><label for="edit-m-dob" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth <span class="text-red-500">*</span></label><input type="date" id="edit-m-dob" name="dob" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                         <div><label for="edit-m-contact" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Number <span class="text-red-500">*</span></label><input type="tel" id="edit-m-contact" name="contact" required placeholder="e.g., 555-123-4567" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" title="Format: 555-123-4567" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-sm shadow-sm"/></div>
                    </div>
                     <p class="text-sm text-gray-500 dark:text-gray-400 italic"> (Other fields omitted for brevity - structure is same as Add Patient form) </p>
                    <div class="flex justify-end gap-3 pt-5 border-t dark:border-gray-700 mt-6">
                        <button type="button" class="modal-close-button font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 focus:ring-gray-400 dark:focus:ring-gray-500 border border-gray-300 dark:border-gray-500 py-2 px-4 text-sm">Cancel</button>
                        <button type="submit" class="font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500 py-2 px-4 text-sm">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="delete-confirm-modal-title" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700 rounded-t-lg flex-shrink-0"><h3 id="delete-confirm-modal-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Confirm Deletion</h3><button type="button" class="modal-close-button text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Close modal"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x-circle.svg" alt="Close" class="w-6 h-6 pointer-events-none"/></button></div>
            <div class="p-6 overflow-y-auto flex-grow">
                <p id="delete-confirm-message" class="text-gray-700 dark:text-gray-300 mb-4">Are you sure you want to delete this patient?</p>
                <p class="text-sm text-red-600 dark:text-red-400 mb-4">This action cannot be undone.</p>
            </div>
            <div class="flex justify-end gap-3 p-4 border-t dark:border-gray-700 mt-auto bg-gray-50 dark:bg-gray-700 rounded-b-lg">
                <button type="button" class="modal-close-button font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 focus:ring-gray-400 dark:focus:ring-gray-500 border border-gray-300 dark:border-gray-500 py-2 px-4 text-sm">Cancel</button>
                <button type="button" id="confirm-delete-button" data-testid="confirm-delete-button" class="font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-red-600 hover:bg-red-700 text-white focus:ring-red-500 py-2 px-4 text-sm">Delete Patient</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" role="dialog" aria-modal="true" aria-labelledby="notification-modal-title" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700 rounded-t-lg flex-shrink-0"><h3 id="notification-modal-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Notifications</h3><button type="button" class="modal-close-button text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" aria-label="Close modal"><img loading="lazy" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x-circle.svg" alt="Close" class="w-6 h-6 pointer-events-none"/></button></div>
            <div class="p-6 overflow-y-auto flex-grow"><p class="text-center text-gray-600 dark:text-gray-300">There are no new notifications.</p></div>
             <div class="flex justify-end gap-3 p-4 border-t dark:border-gray-700 mt-auto bg-gray-50 dark:bg-gray-700"><button type="button" class="modal-close-button font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out inline-flex items-center justify-center bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 focus:ring-gray-400 dark:focus:ring-gray-500 border border-gray-300 dark:border-gray-500 py-1.5 px-3 text-xs">Close</button></div>
        </div>
    </div>

    <script id="script" type="module">
        // --- Mock Data & State ---
        const MOCK_USERS = { admin: { password: 'password', role: 'Administrator', name: 'Admin User' }, doctor: { password: 'password', role: 'Doctor', name: 'Dr. Rohan Gupta' }, staff: { password: 'password', role: 'Staff', name: 'Staff Member' } };
        let currentUser = null;
        let currentPage = 'dashboard';
        let patientToDelete = null;

        // --- DOM Elements ---
        const htmlElement = document.documentElement;
        const loginScreen = document.getElementById('login-screen'), mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username'), passwordInput = document.getElementById('password');
        const logoutButton = document.getElementById('logout-button'), sidebarNav = document.getElementById('sidebar-nav');
        const pageContents = document.querySelectorAll('.page-content');
        const userNameDisplay = document.getElementById('user-name'), userRoleDisplay = document.getElementById('user-role'), userAvatar = document.getElementById('user-avatar');
        const notificationButton = document.getElementById('notification-button'), notificationBadge = document.getElementById('notification-badge');
        const patientTableBody = document.getElementById('patient-table-body');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const loginButton = document.getElementById('login-button');
        const loginButtonDefaultText = loginButton?.querySelector('.default-text');
        const loginButtonLoadingState = loginButton?.querySelector('.loading-state');

        // Modals
        const addPatientModal = document.getElementById('add-patient-modal'), addPatientButton = document.getElementById('add-patient-button');
        const notificationModal = document.getElementById('notification-modal');
        const editPatientModal = document.getElementById('edit-patient-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editPatientIdInput = document.getElementById('edit-patient-id');
        const editPatientNameInput = document.getElementById('edit-m-name');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');

        // Forms
        const addPatientForm = document.getElementById('add-patient-form');
        const editPatientForm = document.getElementById('edit-patient-form');
        // ** NEW ** Settings Page Elements
        const profileForm = document.getElementById('profile-form');
        const notifyAppCheckbox = document.getElementById('notify-app');
        const userTableBody = document.getElementById('user-table-body');


        // --- Functions ---
        function setLoginLoading(isLoading) {
            if (!loginButton || !loginButtonDefaultText || !loginButtonLoadingState) return;
            loginButton.disabled = isLoading;
            loginButtonDefaultText.classList.toggle('hidden', isLoading);
            loginButtonLoadingState.classList.toggle('hidden', !isLoading);
            loginButtonLoadingState.classList.toggle('flex', isLoading);
            loginButton.setAttribute('aria-busy', isLoading ? 'true' : 'false');
        }

        async function login(username, password) {
            setLoginLoading(true);
            loginError.classList.add('hidden');

            const mockLoginEndpoint = async () => {
                await new Promise(res => setTimeout(res, 500));
                const lowerCaseUsername = username.toLowerCase();
                const user = MOCK_USERS[lowerCaseUsername];
                if (user && user.password === password) {
                    return { success: true, user: { username: lowerCaseUsername, role: user.role, name: user.name } };
                } else {
                    return { success: false, message: 'Invalid credentials' };
                }
            };

            try {
                const response = await mockLoginEndpoint();
                if (response.success) {
                    currentUser = response.user;
                    sessionStorage.setItem('crmUser', JSON.stringify(currentUser));
                    console.log('Login successful:', currentUser);
                    setLoginLoading(false);
                    return true;
                } else {
                    console.log('Login failed:', response.message);
                    loginError.textContent = response.message || 'Invalid username or password.';
                    loginError.classList.remove('hidden');
                    setLoginLoading(false);
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'An error occurred during login.';
                loginError.classList.remove('hidden');
                setLoginLoading(false);
                return false;
            }
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('crmUser');
            showLoginScreen();
            console.log('Logged out');
        }
        function showLoginScreen() { /* ... */
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginError.classList.add('hidden');
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        // ** MODIFIED showMainApp to include Settings functions **
        function showMainApp() {
            if (!currentUser) {
                const storedUser = sessionStorage.getItem('crmUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                } else {
                    showLoginScreen();
                    return;
                }
            }
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            userNameDisplay.textContent = currentUser.name;
            userRoleDisplay.textContent = currentUser.role;
            userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            updateNotificationBadge(0);
            applyPermissions();
            navigateTo(currentPage); // Navigate first

            // Load settings data after main app is shown
            loadUserProfile();
            loadNotificationPrefs();
            if (currentUser.role === 'Administrator' && userTableBody) {
                populateUserTable();
            }
        }
        function updateNotificationBadge(count) { /* ... */
             if (count > 0) {
                notificationBadge.textContent = count > 9 ? '9+' : count;
                notificationBadge.classList.remove('hidden');
                notificationButton.setAttribute('title', `${count} unread notifications`);
            } else {
                notificationBadge.classList.add('hidden');
                notificationButton.setAttribute('title', `No new notifications`);
            }
        }
        function applyPermissions() { /* ... */
            if (!currentUser) return;
            const userRoles = [currentUser.role];
            document.querySelectorAll('[data-roles]').forEach(element => {
                const requiredRoles = element.getAttribute('data-roles').split(',');
                const hasAccess = requiredRoles.some(role => userRoles.includes(role.trim()));
                element.classList.toggle('hidden', !hasAccess);
            });
        }
        function navigateTo(pageId) { /* ... */
            console.log(`[DEBUG] Navigating to: ${pageId}`);
            const targetPage = document.getElementById(`page-${pageId}`);
            const accessDeniedPage = document.getElementById('access-denied');
            pageContents.forEach(page => page.classList.add('hidden'));
            let canAccess = true;
            if (targetPage) {
                const requiredRoles = targetPage.getAttribute('data-roles')?.split(',');
                if (requiredRoles && currentUser) {
                    canAccess = requiredRoles.some(role => currentUser.role === role.trim());
                }
                if (canAccess) {
                    targetPage.classList.remove('hidden');
                    currentPage = pageId;
                    updateActiveSidebar(pageId);
                } else {
                    accessDeniedPage.classList.remove('hidden');
                    updateActiveSidebar(null);
                }
            } else {
                console.warn(`Page 'page-${pageId}' not found. Navigating to dashboard.`);
                navigateTo('dashboard');
            }
        }
        function updateActiveSidebar(activePageId) { /* ... */
            sidebarNav.querySelectorAll('.nav-button').forEach(button => {
                const page = button.getAttribute('data-page');
                const icon = button.querySelector('.nav-icon');
                const isActive = page === activePageId;
                button.classList.toggle('bg-blue-600', isActive);
                button.classList.toggle('text-white', isActive);
                button.classList.toggle('shadow-inner', isActive);
                button.classList.toggle('text-gray-300', !isActive);
                button.classList.toggle('hover:bg-gray-700', !isActive);
                button.classList.toggle('hover:text-white', !isActive);
                if (icon) {
                    icon.classList.toggle('invert', isActive);
                    icon.classList.toggle('brightness-0', isActive);
                    icon.classList.toggle('filter', !isActive);
                    icon.classList.toggle('brightness-50', !isActive);
                }
            });
        }
        function openModal(modalElement) { /* ... */
             if (modalElement) {
                modalElement.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }
        function closeModal(modalElement) { /* ... */
             if (modalElement) {
                modalElement.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        function toggleDarkMode() { /* ... */
            htmlElement.classList.toggle('dark');
            if (htmlElement.classList.contains('dark')) {
                sessionStorage.setItem('crmTheme', 'dark');
            } else {
                sessionStorage.setItem('crmTheme', 'light');
            }
        }
        function applyInitialTheme() { /* ... */
            const savedTheme = sessionStorage.getItem('crmTheme');
            if (savedTheme === 'dark') {
                htmlElement.classList.add('dark');
            } else {
                htmlElement.classList.remove('dark');
            }
        }

        // ** NEW Settings Page Functions **
        function loadUserProfile() {
            if (currentUser && profileForm) {
                const nameInput = profileForm.querySelector('#profile-name');
                if(nameInput) nameInput.value = currentUser.name;
                // Clear password field on load
                const passwordInput = profileForm.querySelector('#profile-password');
                if(passwordInput) passwordInput.value = '';
                 console.log('[DEBUG] User profile loaded into settings form.');
            }
        }

        function saveUserProfile(e) {
            e.preventDefault();
            const nameInput = profileForm.querySelector('#profile-name');
            const passwordInput = profileForm.querySelector('#profile-password');
            const name = nameInput?.value.trim();
            const password = passwordInput?.value; // Don't trim password

            if (!name) {
                alert('Name cannot be empty.'); // Basic validation
                return;
            }

            if (currentUser) {
                currentUser.name = name;
                // Only update password in mock data if a new one is entered
                // In a real app, you'd likely have separate current/new password fields
                // and update MOCK_USERS or send to backend.
                // This simulation just updates the current session user object.
                // It does NOT update MOCK_USERS or persist password changes beyond the session.
                console.log(`Profile saved. Name: ${name}`, password ? ', Password updated (in session only)' : '');

                // Update session storage
                sessionStorage.setItem('crmUser', JSON.stringify(currentUser));

                // Update header display immediately
                userNameDisplay.textContent = name;
                userAvatar.textContent = name.charAt(0).toUpperCase();

                // Clear password field after save
                if(passwordInput) passwordInput.value = '';

                alert('Profile saved successfully!'); // Simple feedback
            }
        }

        function updateNotificationPrefs() {
            if (notifyAppCheckbox) {
                sessionStorage.setItem('notifyApp', notifyAppCheckbox.checked);
                console.log('[DEBUG] Notification preference saved:', notifyAppCheckbox.checked);
            }
        }

        function loadNotificationPrefs() {
            if (notifyAppCheckbox) {
                // Default to true if not found in storage
                notifyAppCheckbox.checked = sessionStorage.getItem('notifyApp') !== 'false';
                console.log('[DEBUG] Notification preference loaded:', notifyAppCheckbox.checked);
            }
        }

        function populateUserTable() {
             if (!userTableBody) return;
            userTableBody.innerHTML = ''; // Clear existing rows
            console.log('[DEBUG] Populating user table...');
            Object.entries(MOCK_USERS).forEach(([username, { name, role }]) => {
                const row = document.createElement('tr');
                row.className = 'border-t dark:border-gray-700';
                row.innerHTML = `
                    <td class="p-3 text-gray-700 dark:text-gray-300">${username}</td>
                    <td class="p-3 text-gray-900 dark:text-gray-100">${name}</td>
                    <td class="p-3 text-gray-700 dark:text-gray-300">${role}</td>
                `;
                userTableBody.appendChild(row);
            });
        }


        // --- Event Listeners ---
        if (loginForm) loginForm.addEventListener('submit', async (e) => { /* ... */
             e.preventDefault();
             console.log(`[DEBUG] Login form submitted. User: ${usernameInput.value.trim()}, Pass: ${passwordInput.value}`);
             const success = await login(usernameInput.value.trim(), passwordInput.value);
             if (success) {
                 console.log('[DEBUG] Login success, calling showMainApp()');
                 showMainApp();
             } else {
                 console.log('[DEBUG] Login failed.');
             }
        });
        if (logoutButton) logoutButton.addEventListener('click', logout);
        if (sidebarNav) sidebarNav.addEventListener('click', (e) => { /* ... */
            const button = e.target.closest('.nav-button[data-page]');
            if (button) navigateTo(button.dataset.page);
        });
        document.querySelectorAll('.page-link[data-page]').forEach(link => { /* ... */
            link.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.page));
        });
        if (notificationButton && notificationModal) notificationButton.addEventListener('click', () => { /* ... */
             console.log('Notification button clicked');
             updateNotificationBadge(0);
             openModal(notificationModal);
        });
        if (addPatientButton && addPatientModal) addPatientButton.addEventListener('click', () => { /* ... */
            if (addPatientForm) addPatientForm.reset();
            openModal(addPatientModal);
        });
        if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);

        if (patientTableBody) patientTableBody.addEventListener('click', (e) => { /* ... */
             const editButton = e.target.closest('.edit-patient-button');
            const deleteButton = e.target.closest('.delete-patient-button');
            const row = e.target.closest('tr');
            if (!row) return;
            const patientId = row.dataset.patientId;
            const patientName = row.dataset.patientName;
            if (editButton && editPatientModal) {
                console.log(`Edit clicked for patient: ${patientId} (${patientName})`);
                if(editModalTitle) editModalTitle.textContent = `Edit Patient: ${patientName}`;
                if(editPatientIdInput) editPatientIdInput.value = patientId;
                if(editPatientNameInput) editPatientNameInput.value = patientName;
                openModal(editPatientModal);
            } else if (deleteButton && deleteConfirmModal) {
                console.log(`Delete clicked for patient: ${patientId} (${patientName})`);
                patientToDelete = { id: patientId, name: patientName };
                if(deleteConfirmMessage) deleteConfirmMessage.textContent = `Are you sure you want to delete patient ${patientName} (ID: ${patientId})?`;
                openModal(deleteConfirmModal);
            }
        });
        if (confirmDeleteButton && deleteConfirmModal) confirmDeleteButton.addEventListener('click', () => { /* ... */
             if (patientToDelete) {
                console.log(`Confirmed delete for patient: ${patientToDelete.id} (${patientToDelete.name})`);
                const rowToDelete = patientTableBody.querySelector(`tr[data-patient-id="${patientToDelete.id}"]`);
                if (rowToDelete) rowToDelete.remove();
                closeModal(deleteConfirmModal);
                patientToDelete = null; // Reset state
            }
        });
        if (addPatientForm && addPatientModal) addPatientForm.addEventListener('submit', (e) => { /* ... */
            e.preventDefault(); console.log('Simulating Add Patient...'); closeModal(addPatientModal);
        });
        if (editPatientForm && editPatientModal) editPatientForm.addEventListener('submit', (e) => { /* ... */
             e.preventDefault(); const patientId = editPatientIdInput.value; console.log(`Simulating Save Changes for patient: ${patientId}...`); closeModal(editPatientModal);
        });
        // ** NEW ** Settings Page Listeners
        if (profileForm) profileForm.addEventListener('submit', saveUserProfile);
        if (notifyAppCheckbox) notifyAppCheckbox.addEventListener('change', updateNotificationPrefs);

        // Universal Modal Close Buttons & Overlay
        document.querySelectorAll('.modal-close-button').forEach(button => { /* ... */
            button.addEventListener('click', (e) => closeModal(e.target.closest('.fixed.inset-0')));
        });
         document.querySelectorAll('.fixed.inset-0').forEach(modalOverlay => { /* ... */
             modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(modalOverlay); });
         });

        // --- Initial Setup ---
        applyInitialTheme();
        const storedUser = sessionStorage.getItem('crmUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showMainApp(); // This now calls the settings load functions
        } else {
            showLoginScreen();
        }
    </script>

</body>
</html>
